-- AutoStandableSquares.lua (LocalScript - StarterPlayerScripts)

-- Services
local Players = game:GetService("Players")                   -- 1
local RunService = game:GetService("RunService")            -- 2
local Task = task                                           -- 3

-- Player / Character
local player = Players.LocalPlayer                          -- 4
local character = player.Character or player.CharacterAdded:Wait() -- 5
local hrp = character:WaitForChild("HumanoidRootPart")      -- 6

-- UI
local screenGui = Instance.new("ScreenGui")                 -- 7
screenGui.Name = "AutoStandSquaresGUI"                      -- 8
screenGui.ResetOnSpawn = false                              -- 9
screenGui.Parent = player:WaitForChild("PlayerGui")         -- 10

local toggleBtn = Instance.new("TextButton")                -- 11
toggleBtn.Parent = screenGui                                -- 12
toggleBtn.Size = UDim2.new(0, 160, 0, 40)                   -- 13
toggleBtn.Position = UDim2.new(0, 10, 0, 10)                -- 14
toggleBtn.AnchorPoint = Vector2.new(0, 0)                   -- 15
toggleBtn.Text = "AutoSquares: OFF"                         -- 16
toggleBtn.BackgroundTransparency = 0.2                      -- 17

-- State
local running = false                                       -- 18
local createdParts = {}                                     -- 19
local cycleThread = nil                                     -- 20
local lock = false                                          -- 21

-- Parameters (có thể chỉnh)
local squareSize = Vector3.new(2, 0.5, 2)                   -- 22  (kích thước khối vuông)
local spawnInterval = 0.2                                   -- 23  (delay giữa mỗi part khi đang "on" — 0.2s như yêu cầu)
local activeDuration = 2                                    -- 24  (thời gian bật tạo trong 1 pha)
local pauseDuration = 0.5                                   -- 25  (thời gian tắt để part rơi)
local totalDuration = 7                                     -- 26  (tổng thời gian auto trước khi dừng)
local maxParts = 50                                         -- 27  (giới hạn số part để tránh gây lag)

-- Hàm tạo một part ở vị trí dưới chân (dựa trên HumanoidRootPart)
local function createSquareUnder(position)
    -- Nếu đã đạt giới hạn thì dọn cũ trước khi tạo thêm
    if #createdParts >= maxParts then
        -- huỷ phần cũ nhất để nhường chỗ
        if createdParts[1] and createdParts[1].Parent then
            createdParts[1]:Destroy()
        end
        table.remove(createdParts, 1)
    end

    local part = Instance.new("Part")                       -- 28
    part.Size = squareSize                                  -- 29
    part.Anchored = true                                    -- 30  (neo để người chơi có thể đứng lên)
    part.CanCollide = true                                  -- 31  (cho phép va chạm để đứng trên đó)
    part.Position = position - Vector3.new(0, 3.5, 0)      -- 32  (đặt thấp dưới HRP; điều chỉnh nếu cần)
    part.BrickColor = BrickColor.new("Bright violet")       -- 33  (màu dễ thấy)
    part.Material = Enum.Material.SmoothPlastic             -- 34  (vật liệu)
    part.TopSurface = Enum.SurfaceType.Smooth               -- 35
    part.BottomSurface = Enum.SurfaceType.Smooth            -- 36
    part.Parent = workspace                                 -- 37
    table.insert(createdParts, part)                        -- 38
    return part
end

-- Hàm bỏ neo tất cả part hiện có để chúng rơi
local function unanchorAll()
    for i = #createdParts, 1, -1 do
        local p = createdParts[i]
        if p and p.Parent then
            p.Anchored = false
        end
    end
end

-- Hàm dọn sạch createdParts (hủy các part)
local function clearAll()
    for _, p in ipairs(createdParts) do
        if p and p.Parent then
            p:Destroy()
        end
    end
    createdParts = {}
end

-- Hàm tìm vị trí "dưới chân" dựa trên HumanoidRootPart
local function footPosition()
    -- Dùng HRP để lấy vị trí tham chiếu; offset có thể chỉnh để phù hợp R6/R15
    return hrp.Position
end

-- Hàm thực hiện chu kỳ on/off trong khoảng totalDuration
local function runCycle()
    if lock then return end
    lock = true
    local startTime = tick()
    local elapsed = 0
    while elapsed < totalDuration and running do
        -- PHASE: active (tạo part liên tục trong activeDuration)
        local phaseStart = tick()
        while tick() - phaseStart < activeDuration and running and tick() - startTime < totalDuration do
            -- tạo 1 part dưới chân player
            local pos = footPosition()
            createSquareUnder(pos)
            Task.wait(spawnInterval) -- chờ 0.2s giữa mỗi part
        end

        -- khi kết thúc pha active: bỏ neo để part rơi
        unanchorAll()

        -- nếu hết tổng thời gian hoặc user tắt thì break
        elapsed = tick() - startTime
        if elapsed >= totalDuration or not running then break end

        -- PHASE: pause (chờ pauseDuration để part rơi)
        local pauseStart = tick()
        while tick() - pauseStart < pauseDuration and running and tick() - startTime < totalDuration do
            Task.wait(0.05)
        end

        elapsed = tick() - startTime
    end

    -- Kết thúc: đảm bảo tắt và dọn dẹp (xóa các part sau 1 giây để nhìn thấy hiệu ứng rơi)
    running = false
    lock = false
    Task.delay(1, function()
        clearAll()
    end)
end

-- Xử lý nút toggle
toggleBtn.MouseButton1Click:Connect(function()
    if toggleBtn.Text:find("OFF") then
        -- Bật
        running = true
        toggleBtn.Text = "AutoSquares: ON"
        -- Nếu thread chưa chạy thì start
        if not cycleThread then
            cycleThread = Task.spawn(function()
                runCycle()
                cycleThread = nil
                toggleBtn.Text = "AutoSquares: OFF"
            end)
        end
    else
        -- Tắt sớm
        running = false
        toggleBtn.Text = "AutoSquares: OFF"
        -- bỏ neo để các part rơi ngay
        unanchorAll()
        -- dọn sau 1 giây
        Task.delay(1, clearAll)
    end
end)

-- Nếu character respawn, cập nhật hrp và dọn phần cũ
player.CharacterAdded:Connect(function(char)
    character = char
    hrp = character:WaitForChild("HumanoidRootPart")
    clearAll()
end)
