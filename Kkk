-- AirWalkLocal.lua (LocalScript - StarterPlayerScripts)

-- Services
local Players = game:GetService("Players")                  -- 1
local RunService = game:GetService("RunService")           -- 2

-- Player + character refs
local player = Players.LocalPlayer                         -- 3
local character = player.Character or player.CharacterAdded:Wait() -- 4
local hrp = character:WaitForChild("HumanoidRootPart")     -- 5
local humanoid = character:WaitForChild("Humanoid")        -- 6

-- UI (simple toggle)
local screenGui = Instance.new("ScreenGui")                -- 7
screenGui.Name = "AirWalkGUI"                              -- 8
screenGui.ResetOnSpawn = false                             -- 9
screenGui.Parent = player:WaitForChild("PlayerGui")        -- 10

local toggleBtn = Instance.new("TextButton")               -- 11
toggleBtn.Parent = screenGui                               -- 12
toggleBtn.Size = UDim2.new(0, 160, 0, 40)                  -- 13
toggleBtn.Position = UDim2.new(0, 10, 0, 10)               -- 14
toggleBtn.Text = "AirWalk: OFF"                            -- 15
toggleBtn.BackgroundTransparency = 0.3                     -- 16

-- State
local airPart = nil                                        -- 17 (platform part)
local updating = false                                     -- 18 (flag chạy update)
local offsetY = 3.5                                        -- 19 (khoảng cách từ HRP xuống platform)
local partSize = Vector3.new(4, 0.6, 4)                    -- 20 (kích thước platform)
local updateBind = nil                                     -- 21 (connection để hủy)

-- Tạo platform (invisible or semi-transparent) dưới người
local function createAirPart()
    if airPart and airPart.Parent then return airPart end

    local p = Instance.new("Part")                         -- 22
    p.Size = partSize                                      -- 23
    p.Anchored = true                                      -- 24 (neo để không bị physics ảnh hưởng khi ta dịch chuyển)
    p.CanCollide = true                                    -- 25 (cho phép người chơi đứng lên)
    p.Transparency = 1                                     -- 26 (1 = hoàn toàn trong suốt; đổi nếu muốn nhìn thấy)
    p.CanQuery = false                                     -- 27 (giảm việc raycast không cần thiết)
    p.CanTouch = false                                     -- 28 (nếu cần có thể true để detect chạm; hiện false)
    p.Parent = workspace                                   -- 29
    p.Name = "AirWalkPlatform_" .. player.Name             -- 30

    airPart = p
    return p
end

-- Hủy platform
local function destroyAirPart()
    if airPart then
        if airPart.Parent then airPart:Destroy() end
        airPart = nil
    end
end

-- Update vị trí platform theo HRP mỗi frame (dùng RenderStepped để mượt)
local function startUpdating()
    if updating then return end
    local p = createAirPart()
    updating = true

    updateBind = RunService.RenderStepped:Connect(function()
        if not character or not hrp or not p then return end
        -- Tính vị trí platform: dưới HRP theo offsetY
        local targetCFrame = hrp.CFrame * CFrame.new(0, -offsetY, 0)
        -- Giữ platform thẳng ngang
        local newCFrame = CFrame.new(targetCFrame.Position) * CFrame.Angles(0, hrp.Orientation.Y * math.pi/180, 0)
        -- Gán CFrame trực tiếp (anchored part)
        p.CFrame = newCFrame
    end)
end

-- Dừng cập nhật và xóa platform
local function stopUpdating()
    if updateBind then
        updateBind:Disconnect()
        updateBind = nil
    end
    updating = false
    destroyAirPart()
end

-- Toggle handler
toggleBtn.MouseButton1Click:Connect(function()
    if toggleBtn.Text:find("OFF") then
        -- Bật AirWalk
        toggleBtn.Text = "AirWalk: ON"
        startUpdating()
        -- Khi bật, bỏ trạng thái nhảy để tránh phạm luật vật lý khi đứng trên platform
        if humanoid then
            humanoid.PlatformStand = false
        end
    else
        -- Tắt AirWalk
        toggleBtn.Text = "AirWalk: OFF"
        stopUpdating()
    end
end)

-- Nếu respawn thì dọn sạch và cập nhật tham chiếu
player.CharacterAdded:Connect(function(char)
    -- dọn cũ nếu có
    stopUpdating()
    character = char
    hrp = character:WaitForChild("HumanoidRootPart")
    humanoid = character:WaitForChild("Humanoid")
end)
